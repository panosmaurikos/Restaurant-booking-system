  name: DevSecOps - Snyk

  on:
    workflow_call:
      secrets:
        SNYK_TOKEN:
          required: true

  permissions:
    contents: read

  jobs:
    snyk-scan:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4

        - name: Debug SNYK_TOKEN
          env:
            SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          run: |
            if [ -z "$SNYK_TOKEN" ]; then
              echo " SNYK_TOKEN is empty"
            else
              echo " SNYK_TOKEN is set"
            fi

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        #  Build backend image
        - name: Build backend image
          run: docker build -t restaurant_backend:ci -f Dockerfile-backend .

        #  Build frontend image
        - name: Build frontend image
          run: docker build -t restaurant_frontend:ci -f Dockerfile-frontend .

        #  Scan backend image
        - name: Run Snyk scan (backend)
          uses: snyk/actions/docker@master
          continue-on-error: true   
          env:
            SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          with:
            image: restaurant_backend:ci
            args: --json-file-output=snyk-backend.json

        #  Scan frontend image
        - name: Run Snyk scan (frontend)
          uses: snyk/actions/docker@master
          env:
            SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          with:
            image: restaurant_frontend:ci
            args: --json-file-output=snyk-frontend.json

        #  Upload JSON reports
        - name: Upload Snyk JSON reports
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: snyk-json-reports
            path: |
              snyk-backend.json
              snyk-frontend.json

        - name: Upload Snyk JSON reports
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: snyk-json-reports
            path: | 
              snyk-backend.json
              snyk-frontend.json

        - name: Display Snyk results
          run: |
            echo " SNYK SCAN RESULTS"
            echo "===================="
            
            # Backend results
            if [ -f snyk-backend.json ]; then
              echo "ðŸ”§ BACKEND:"
              backend_vulns=$(jq '.vulnerabilities | length' snyk-backend.json || echo 0)
              echo "Vulnerabilities found: $backend_vulns"
              
              if [ "$backend_vulns" -gt 0 ]; then
                echo " VULNERABILITIES:"
                jq -r '.vulnerabilities[] | "\(.id) - \(.title)\n  Severity: \(.severity)\n  Package: \(.packageName)\n  Version: \(.version)\n  Info: \(.description)\n"' snyk-backend.json
              else
                echo " No vulnerabilities found in backend"
              fi
            else
              echo " snyk-backend.json not found"
            fi
            
            echo ""
            
            # Frontend results  
            if [ -f snyk-frontend.json ]; then
              echo " FRONTEND:"
              frontend_vulns=$(jq '.vulnerabilities | length' snyk-frontend.json || echo 0)
              echo "Vulnerabilities found: $frontend_vulns"
              
              if [ "$frontend_vulns" -gt 0 ]; then
                echo " VULNERABILITIES:"
                jq -r '.vulnerabilities[] | "\(.id) - \(.title)\n  Severity: \(.severity)\n  Package: \(.packageName)\n  Version: \(.version)\n  Info: \(.description)\n"' snyk-frontend.json
              else
                echo " No vulnerabilities found in frontend"
              fi
            else
              echo " snyk-frontend.json not found"
            fi

        - name: Upload Snyk JSON reports
          uses: actions/upload-artifact@v4
          with:
            name: snyk-json-reports
            path: |
              snyk-backend.json
              snyk-frontend.json

        - name: Fail if vulnerabilities found
          run: |
            total_vulns=0
            
            if [ -f snyk-backend.json ]; then
              backend_vulns=$(jq '.vulnerabilities | length' snyk-backend.json || echo 0)
              total_vulns=$((total_vulns + backend_vulns))
            fi
            
            if [ -f snyk-frontend.json ]; then
              frontend_vulns=$(jq '.vulnerabilities | length' snyk-frontend.json || echo 0)
              total_vulns=$((total_vulns + frontend_vulns))
            fi
            
            if [ "$total_vulns" -gt 0 ]; then
              echo "Found $total_vulns total vulnerabilities - failing workflow"
              exit 1
            else
              echo "No vulnerabilities found - scan passed"
            fi