name: Nmap Security Scan

on:
  workflow_call:

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and start services
        run: docker compose -f docker-compose.yml up -d --build

      - name: Wait for app to be ready
        run: |
          echo "Waiting for app to start..."
          for i in {1..15}; do
            if curl -s http://localhost:8080 >/dev/null; then
              echo "App is up!"
              exit 0
            fi
            echo "Still waiting..."
            sleep 5
          done
          echo "App did not start in time" >&2
          docker compose logs
          exit 1

      - name: Run comprehensive Nmap security scan
        run: |
            # Create a directory for nmap results
            mkdir -p nmap-results
            sudo chmod 777 nmap-results

            # Run nmap with volume mounting
            docker run --network=host \
            -v $(pwd)/nmap-results:/results \
            instrumentisto/nmap \
            -sS -sV -sC -O -T4 -v -p- \
            -oX /results/nmap-full-scan.xml \
            -oN /results/nmap-full-scan.txt \
            localhost

      - name: Run targeted vulnerability scans
        run: |
             sudo chmod 777 nmap-results
             docker run --network=host -v $(pwd)/nmap-results:/results instrumentisto/nmap --script vulners,http-enum,http-security-headers -p 8080,8081 -oX /results/nmap-web-scan.xml -oN /results/nmap-web-scan.txt localhost

             docker run --network=host -v $(pwd)/nmap-results:/results instrumentisto/nmap --script pgsql-brute -p 5432 -oX /results/nmap-pgsql-scan.xml -oN /results/nmap-pgsql-scan.txt localhost

             docker run --network=host -v $(pwd)/nmap-results:/results instrumentisto/nmap --script redis-info -p 6379 -oX /results/nmap-redis-scan.xml -oN /results/nmap-redis-scan.txt localhost

      - name: Verify scan files were created
        run: |
          echo "=== Checking for scan files ==="
          sudo chmod -R 777 nmap-results
          sudo chown -R $USER:$USER nmap-results
          ls -la nmap-results/
          
          # Copy files to root for easier access
          cp nmap-results/* .
          
          echo "âœ… All scan files:"
          ls -la *.xml *.txt

      - name: Generate comprehensive HTML reports
        run: |
            sudo apt-get install -y xsltproc pandoc curl
            curl -s https://svn.nmap.org/nmap/docs/nmap.xsl -o nmap.xsl
            
            # Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î± Î Î¡Î‘Î“ÎœÎ‘Î¤Î™ÎšÎ‘ Î¿Î½ÏŒÎ¼Î±Ï„Î± Î±ÏÏ‡ÎµÎ¯Ï‰Î½ Ï€Î¿Ï… Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½
            xsltproc -o nmap-full-report.html nmap.xsl nmap-full-scan.xml
            xsltproc -o nmap-web-report.html nmap.xsl nmap-web-scan.xml
            xsltproc -o nmap-pgsql-report.html nmap.xsl nmap-pgsql-scan.xml
            xsltproc -o nmap-redis-report.html nmap.xsl nmap-redis-scan.xml

            cat > security-summary.md << EOF
                # ðŸ›¡ï¸ Application Security Scan Report

                ## ðŸ“… Scan Date: $(date)
                ## ðŸŽ¯ Target: localhost

                ## ðŸ“Š Application Ports Scan
                \`\`\`bash
                $(grep "open" nmap-full-scan.txt | sort -n)
                \`\`\`

                ## ðŸŒ Web Application Details
                \`\`\`bash
                $(grep -A3 -B2 "8080/tcp\|8081/tcp" nmap-full-scan.txt)
                \`\`\`

                ## ðŸ—„ï¸ Database Services
                \`\`\`bash
                $(grep -A3 -B2 "5432/tcp\|6379/tcp" nmap-full-scan.txt)
                \`\`\`

                ## ðŸ” Detected Services
                \`\`\`bash
                $(grep -E "Apache|nginx|Tomcat|PostgreSQL|Redis" nmap-full-scan.txt | head -8)
                \`\`\`

                ## âš¡ Quick Stats
                - **Open Ports**: $(grep -c "open" nmap-full-scan.txt)
                - **Web Services**: 2 (Tomcat + nginx)
                - **Database Services**: 2 (PostgreSQL + Redis)
                - **Scan Type**: Comprehensive security assessment
            EOF

                    pandoc security-summary.md -o security-summary.html --self-contained --css=https://cdn.jsdelivr.net/npm/water.css@2/out/water.css
      - name: Upload comprehensive reports
        uses: actions/upload-artifact@v4
        with:
            name: security-scan-reports-$(date +%Y%m%d-%H%M%S)
            path: |
              nmap-*.xml
              nmap-*.txt
              *-report.html
              security-summary.*
              nmap-results/

      - name: Display security summary
        run: |
            echo "ðŸ”’ APPLICATION SECURITY SCAN COMPLETED ðŸ”’"
            echo "=========================================="
            echo "ðŸ“Š Open ports found:"
            grep "open" nmap-full-scan.txt | sort -n
            echo ""
            echo "ðŸŒ Web server details:"
            grep -A5 -B2 "8080/tcp\|8081/tcp" nmap-full-scan.txt
            echo ""
            echo "ðŸ—„ï¸ Database details:"
            grep -A5 -B2 "5432/tcp\|6379/tcp" nmap-full-scan.txt
            echo ""
            echo "ðŸ” Service versions:"
            grep -E "Service|Version|Apache|nginx|Tomcat|PostgreSQL|Redis" nmap-full-scan.txt | head -10
            echo ""
            echo "ðŸ“ Full security reports available as artifacts"

      - name: Stop services
        run: docker compose -f docker-compose.yml down
